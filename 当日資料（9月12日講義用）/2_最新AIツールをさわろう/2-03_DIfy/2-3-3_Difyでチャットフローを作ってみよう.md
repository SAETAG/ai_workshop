# 2-4-1: Difyでチャットフローを作ってみよう

## チャットフロー作成（実践）

### チャットフローとは
条件分岐や複数ステップの処理を視覚的に設計できる機能。複雑な業務フローの自動化、段階的な情報収集、条件に応じた異なる応答が必要な場合に使用します。ノードをつなげてワークフローを作成します。

---

## 【操作手順】

### 基本的な作成フロー

1. 「アプリを作成」ボタン（青色）をクリック
2. 「チャットフロー」のカードを選択
3. アプリ名と説明を入力
4. 「作成」ボタンをクリック
5. キャンバス上でノードを配置・接続
6. 各ノードの詳細（プロンプトなど）を設定
7. 画面上部の「保存」ボタンをクリック
8. プレビュー画面でテスト
9. 動作確認後、「公開」ボタンで完成

---

## 作成事例：炎上防止チェッカー 🔥

### 1. アプリ作成

まずは、チャットフローアプリの土台を作成します。選択するモデルは、今回：Gemini 1.5 Flash

1. Difyのホーム画面左上にある青色の「アプリを作成」ボタンをクリックします。
2. 画面に表示されるカードの中から「チャットフロー」を選択します。
3. 「アプリ名」の入力欄に「炎上防止チェッカー」と入力します。
4. 「作成」ボタンをクリックすると、チャットフローを編集するキャンバス画面が開きます。

### 2. ノードの配置と命名

最初に、アプリの骨格となるノードをすべて配置し、分かりやすいように名前を変更します。

1. 「開始」ノードの右側の「＋」をクリック → 「LLM」を選択し、「炎上リスク分析」という名前に変更します。
2. 「炎上リスク分析」ノードの「＋」をクリック → 「IF/ELSE」を選択します。
3. IF/ELSEノードのIF分岐から「＋」をクリック → 「LLM」を選択し、「緊急修正提案」という名前に変更します。
4. 「緊急修正提案」ノードの「＋」をクリック → 「回答」を選択し、「回答「修正案」」という名前に変更します。
5. IF/ELSEノードのELSE分岐から「＋」をクリック → 「回答」を選択し、「回答「安全」」という名前に変更します。

**【完成後のフロー図】**
```
開始 → 炎上リスク分析 → IF/ELSE
├─ [IF分岐] → 緊急修正提案 → 回答「修正案」
└─ [ELSE分岐] → 回答「安全」
```

最終的に、上記の流れになっていれば完璧です。

### 3. 詳細設定

アプリの挙動を決定づける重要な設定を行います。

#### 3-1. アプリの最初の挨拶（会話の開始）を設定する（推奨）

ユーザーがアプリを開いたときに表示される最初のメッセージを設定します。

1. キャンバス画面の右上の「機能」ボタンをクリックします。
2. 「会話の開始」を見つけ、スイッチを有効（ON）にします。
3. 表示された入力欄に、以下の挨拶文などを貼り付けます：

```
こんにちは！あなたの文章に炎上のリスクがないか、AIが診断します。
チェックしたい文章を、下の入力欄に貼り付けて送ってください。
```

#### 3-2. 各ノードの詳細を設定する

**① 「炎上リスク分析」ノード**

ユーザーの入力を受け取り、リスクを「危険」か「安全」かで判定させます。

1. 「炎上リスク分析」ノードをクリックします。
2. 「プロンプト」セクションに以下を設定します：

**SYSTEM:**
```
あなたは炎上リスクを分析するPR専門家です。過去の炎上事例に詳しく、危険な表現を見抜くプロフェッショナルです。
```

**USER:**
```
以下の発信内容を分析してください。

内容：{{#開始.sys.query#}}

以下の観点でチェックして、リスクレベルを「危険」か「安全」で判定してください：
・差別的表現の有無
・政治的な偏り
・ジェンダー問題
・文化的配慮不足
・誇大表現
・タイミングの問題
```

**② 「IF/ELSE」ノード**

「危険」という文字が含まれているかどうかで、処理を分岐させます。

1. 「IF/ELSE」ノードをクリックします。
2. IF条件を以下のように設定します：
```
{{#炎上リスク分析.text#}} contains 危険
```
（※ELIFは使用しません）

**③ 「緊急修正提案」ノード (危険な場合)**

炎上ポイントの指摘と、具体的な修正文章を生成させます。

1. 「緊急修正提案」ノードをクリックします。
2. 「プロンプト」セクションに以下を設定します：

**SYSTEM:**
```
あなたは緊急事態対応のPRコンサルタントです。炎上を回避するための修正案を迅速に提案する専門家です。
```

**USER:**
```
指示
以下の「分析結果」と「元の文章」を参考に、最も重大な「炎上ポイント」と、それを解消した「修正文章」の2点だけを出力してください。

分析結果
{{#炎上リスク分析.text#}}

元の文章
{{#開始.sys.query#}}

出力形式
必ず以下のフォーマットを守り、他の余計な挨拶や説明は絶対に含めないでください。
【炎上ポイント】：（ここに炎上ポイントを記述）
【修正文章】：（ここに修正文章を記述）
```

3. 「＋メッセージ追加」からASSISTANTを選択して追加し、以下を入力：

**ASSISTANT:**
```
簡潔に回答してください。
```

**④ 各「回答」ノード**

最終結果をユーザーに表示します。

「回答「修正案」」ノード：
- 応答の入力欄に以下を設定：
```
{{#緊急修正提案.text#}}
```

「回答「安全」」ノード：
- 応答の入力欄に、以下の固定メッセージを入力：
```
炎上リスクはありません！お疲れ様でした！
```

### 4. テスト実行と公開

最後に、完成したアプリの動作を確認します。

1. 画面上部の「保存」ボタンをクリックします。

2. 右側のプレビューで、以下の例文（意図的に炎上要素を含む）を入力して送信：
```
女性は細かいことにこだわるから、営業職より事務職が向いている
```

3. 「危険」と判定され、修正案が表示されることを確認します。

4. 次に、以下の安全な例文を入力して送信：
```
弊社は全ての従業員が活躍できる職場環境づくりに取り組んでいます
```

5. 「安全」と判定されることを確認します。

6. 動作に問題がなければ、「公開」ボタンをクリックして完成です！

---

## 💡 ポイント

- ノードの接続は視覚的にドラッグ＆ドロップで行えます
- 条件分岐を活用することで、複雑な判定ロジックを実装できます
- プロンプトの精度が判定の品質を決定します
- テストを繰り返して、判定基準を調整しましょう

---

**次のステップ**: チャットフローの基本が理解できたら、より複雑なワークフローにも挑戦してみましょう！